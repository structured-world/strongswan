name: Build Packages

on:
  workflow_call:
    inputs:
      upstream_version:
        description: 'Upstream strongSwan version'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      upstream_version:
        description: 'Upstream version (leave empty for auto-detect)'
        required: false
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      upstream_version: ${{ steps.version.outputs.upstream_version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.upstream_version }}" ]; then
            UPSTREAM_VERSION="${{ inputs.upstream_version }}"
          else
            # Get from configure.ac
            UPSTREAM_VERSION=$(grep -m1 'AC_INIT' configure.ac | sed -E 's/.*\[([0-9]+\.[0-9]+\.[0-9]+)\].*/\1/')
          fi

          # SW version: upstream-sw.N where N increments for each build
          # TODO: Auto-increment by checking existing releases. For now,
          # manually update when rebuilding same upstream version.
          VERSION="${UPSTREAM_VERSION}-sw.1"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION (based on upstream $UPSTREAM_VERSION)"

  build:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            dist: noble
            libssl: libssl3t64
            arch: amd64
          - os: ubuntu-22.04
            dist: jammy
            libssl: libssl3
            arch: amd64
          # Debian 12 uses ubuntu-latest with different packages
          - os: ubuntu-latest
            dist: bookworm
            libssl: libssl3
            arch: amd64
            debian: true

    runs-on: ${{ matrix.os }}
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            autoconf \
            automake \
            libtool \
            pkg-config \
            gettext \
            libgmp-dev \
            libssl-dev \
            libcurl4-openssl-dev \
            libpq-dev \
            libsystemd-dev \
            libcap-dev \
            libpam0g-dev \
            libldap2-dev \
            libsqlite3-dev \
            libgcrypt20-dev \
            dpkg-dev \
            fakeroot \
            debhelper

      - name: Build strongSwan
        run: |
          autoreconf -i
          ./configure \
            --prefix=/usr \
            --sysconfdir=/etc \
            --libdir=/usr/lib \
            --libexecdir=/usr/lib \
            --enable-eap-identity \
            --enable-eap-mschapv2 \
            --enable-eap-radius \
            --enable-eap-tls \
            --enable-xauth-eap \
            --enable-vici \
            --enable-swanctl \
            --enable-sql \
            --enable-pgsql \
            --enable-sqlite \
            --enable-systemd \
            --enable-openssl \
            --enable-curl \
            --enable-ldap \
            --enable-pam \
            --enable-gcrypt \
            --enable-farp \
            --enable-dhcp \
            --enable-attr-sql \
            --disable-static

          make -j$(nproc)

      - name: Create DEB packages
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          DIST="${{ matrix.dist }}"
          ARCH="${{ matrix.arch }}"
          LIBSSL="${{ matrix.libssl }}"

          # Main package
          PKGDIR="strongswan-sw_${VERSION}_${DIST}_${ARCH}"
          mkdir -p "${PKGDIR}/DEBIAN"

          make DESTDIR="$(pwd)/${PKGDIR}" install

          cat > "${PKGDIR}/DEBIAN/control" << EOF
          Package: strongswan-sw
          Version: ${VERSION}
          Section: net
          Priority: optional
          Architecture: ${ARCH}
          Depends: libgmp10, ${LIBSSL}, libcurl4, libsystemd0, libcap2, libpam0g, libldap-2.5-0, libsqlite3-0, libgcrypt20, libpq5
          Conflicts: strongswan, strongswan-charon, strongswan-starter
          Replaces: strongswan, strongswan-charon, strongswan-starter
          Maintainer: Structured World Foundation <dev@sw.foundation>
          Homepage: https://github.com/structured-world/strongswan
          Description: strongSwan IPsec (SW fork with pgsql support)
           strongSwan is a complete IPsec implementation for Linux.
           This is the Structured World fork with:
           - Socket permissions fix (umask 0660 for Unix sockets)
           - PostgreSQL database plugin for SQL authentication
          EOF

          fakeroot dpkg-deb --build "${PKGDIR}"

          # PostgreSQL plugin package
          PGSQL_PKGDIR="strongswan-pgsql_${VERSION}_${DIST}_${ARCH}"
          mkdir -p "${PGSQL_PKGDIR}/DEBIAN"
          mkdir -p "${PGSQL_PKGDIR}/usr/lib/ipsec/plugins"
          mkdir -p "${PGSQL_PKGDIR}/etc/strongswan.d/charon"

          # Copy pgsql plugin - try known locations, then search
          cp -a "${PKGDIR}/usr/lib/ipsec/plugins/libstrongswan-pgsql.so" "${PGSQL_PKGDIR}/usr/lib/ipsec/plugins/" 2>/dev/null || \
          cp -a "${PKGDIR}/usr/lib/strongswan/plugins/libstrongswan-pgsql.so" "${PGSQL_PKGDIR}/usr/lib/ipsec/plugins/" 2>/dev/null || \
          find "${PKGDIR}" -name "libstrongswan-pgsql.so" -exec cp {} "${PGSQL_PKGDIR}/usr/lib/ipsec/plugins/" \;

          # Verify the plugin was copied successfully
          if [ ! -f "${PGSQL_PKGDIR}/usr/lib/ipsec/plugins/libstrongswan-pgsql.so" ]; then
            echo "ERROR: PostgreSQL plugin not found in build output"
            echo "Searched locations:"
            find "${PKGDIR}" -name "*.so" -path "*/plugins/*" | head -20
            exit 1
          fi

          cat > "${PGSQL_PKGDIR}/DEBIAN/control" << EOF
          Package: strongswan-pgsql
          Version: ${VERSION}
          Section: net
          Priority: optional
          Architecture: ${ARCH}
          Depends: strongswan-sw (= ${VERSION}), libpq5
          Maintainer: Structured World Foundation <dev@sw.foundation>
          Homepage: https://github.com/structured-world/strongswan
          Description: PostgreSQL plugin for strongSwan (SW fork)
           PostgreSQL database backend for strongSwan SQL plugin.
           Enables storing VPN user credentials and configuration in PostgreSQL.
          EOF

          fakeroot dpkg-deb --build "${PGSQL_PKGDIR}"

          # Rename to standard format
          mv "${PKGDIR}.deb" "strongswan-sw_${VERSION}_${DIST}_${ARCH}.deb"
          mv "${PGSQL_PKGDIR}.deb" "strongswan-pgsql_${VERSION}_${DIST}_${ARCH}.deb"

          ls -la *.deb

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.dist }}-${{ matrix.arch }}
          path: "*.deb"
          retention-days: 90

  release:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages
          pattern: deb-*
          merge-multiple: true

      - name: List packages
        run: ls -la packages/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: strongSwan SW ${{ needs.prepare.outputs.version }}
          body: |
            ## strongSwan SW Fork v${{ needs.prepare.outputs.version }}

            Based on upstream strongSwan **${{ needs.prepare.outputs.upstream_version }}**

            ### Changes from upstream:
            - Socket permissions fix (umask 0660 for Unix sockets)
            - PostgreSQL database plugin for SQL authentication

            ### Packages:
            | Package | Description |
            |---------|-------------|
            | `strongswan-sw` | Main package with all standard plugins |
            | `strongswan-pgsql` | PostgreSQL database plugin |

            ### Supported distributions:
            - Ubuntu 24.04 (Noble)
            - Ubuntu 22.04 (Jammy)
            - Debian 12 (Bookworm)

            ### Installation:
            ```bash
            # Download packages for your distribution
            wget https://github.com/structured-world/strongswan/releases/download/v${{ needs.prepare.outputs.version }}/strongswan-sw_${{ needs.prepare.outputs.version }}_<dist>_amd64.deb
            wget https://github.com/structured-world/strongswan/releases/download/v${{ needs.prepare.outputs.version }}/strongswan-pgsql_${{ needs.prepare.outputs.version }}_<dist>_amd64.deb

            # Install
            sudo dpkg -i strongswan-sw_*.deb strongswan-pgsql_*.deb
            sudo apt-get install -f  # Install dependencies
            ```
          files: packages/*.deb
          draft: false
          prerelease: false
