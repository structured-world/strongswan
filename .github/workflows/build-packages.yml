name: Build Packages

on:
  pull_request:
    branches: [sw]
    types: [closed]
  workflow_call:
    inputs:
      upstream_version:
        description: 'Upstream strongSwan version'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      upstream_version:
        description: 'Upstream version (leave empty for auto-detect)'
        required: false
        type: string

jobs:
  prepare:
    # Run only on merged PRs, workflow_call, or workflow_dispatch
    if: github.event.pull_request.merged == true || github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      rpm_version: ${{ steps.version.outputs.rpm_version }}
      upstream_version: ${{ steps.version.outputs.upstream_version }}
      sw_rev: ${{ steps.version.outputs.sw_rev }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # For merged PR events, checkout the merge commit SHA to ensure it's visible
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.merged && github.event.pull_request.merge_commit_sha || 'sw' }}
          fetch-depth: 0
          fetch-tags: true

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.upstream_version }}" ]; then
            UPSTREAM_VERSION="${{ inputs.upstream_version }}"
          else
            # Get from configure.ac
            UPSTREAM_VERSION=$(grep -m1 'AC_INIT' configure.ac | sed -E 's/.*\[([0-9]+\.[0-9]+\.[0-9]+)\].*/\1/')
          fi

          # Validate UPSTREAM_VERSION is not empty and matches expected format
          if [[ ! "$UPSTREAM_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Invalid UPSTREAM_VERSION: '$UPSTREAM_VERSION'" >&2
            exit 1
          fi

          # Count PR merges after upstream tag to determine SW revision number
          # GitHub adds "(#N)" suffix on squash merge, so we count those
          # This auto-increments: sw.1 -> sw.2 -> sw.3 on each PR merge to sw branch
          # When upstream releases new version, we rebase and SW_REV resets to 1
          # IMPORTANT: Repository MUST use squash merging for PRs to sw branch
          # Manual commits or merge commits won't increment the version number
          # Use git tag -l to check for tags only (git rev-parse would also match branches)
          if git tag -l "${UPSTREAM_VERSION}" | grep -q .; then
            # Tag exists - count squash merged PRs (commits with (#N) suffix)
            # Note: This pattern matches GitHub's squash merge format; manual commits
            # with similar suffixes are unlikely and would only inflate the version
            SW_REV=$(git log "${UPSTREAM_VERSION}..HEAD" --oneline | grep -E -c '\(#[0-9]+\)$' || echo 0)
            # Default to 1 if no PR merges found (minimum is sw.1)
            [ "$SW_REV" -eq 0 ] && SW_REV=1
          else
            # No tag yet - use 1
            SW_REV=1
          fi

          # SW version for DEB: upstream-sw.N (dashes allowed)
          VERSION="${UPSTREAM_VERSION}-sw.${SW_REV}"
          # SW version for RPM: upstream.sw.N (no dashes allowed in Version field)
          RPM_VERSION="${UPSTREAM_VERSION}.sw.${SW_REV}"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "rpm_version=$RPM_VERSION" >> $GITHUB_OUTPUT
          echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          echo "sw_rev=$SW_REV" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION / RPM: $RPM_VERSION (upstream $UPSTREAM_VERSION, SW revision $SW_REV)"

  build-deb:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            dist: noble
            libssl: libssl3t64
            libldap: libldap-2.5-0
            arch: amd64
          - os: ubuntu-22.04
            dist: jammy
            libssl: libssl3
            libldap: libldap-2.5-0
            arch: amd64
          - os: ubuntu-22.04
            dist: bookworm
            libssl: libssl3
            libldap: libldap-2.5-0
            arch: amd64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            autoconf \
            automake \
            libtool \
            pkg-config \
            gettext \
            libgmp-dev \
            libssl-dev \
            libcurl4-openssl-dev \
            libpq-dev \
            libsystemd-dev \
            libcap-dev \
            libpam0g-dev \
            libldap2-dev \
            libsqlite3-dev \
            libgcrypt20-dev \
            libiptc-dev \
            gperf \
            flex \
            bison \
            dpkg-dev \
            fakeroot \
            debhelper

      - name: Build strongSwan
        run: |
          UPSTREAM="${{ needs.prepare.outputs.upstream_version }}"

          # Create git tag to satisfy strongSwan version check
          git config user.email "build@sw.foundation"
          git config user.name "Build"
          git tag -f "$UPSTREAM"

          autoreconf -i
          ./configure \
            --prefix=/usr \
            --sysconfdir=/etc \
            --libdir=/usr/lib \
            --libexecdir=/usr/lib \
            --enable-eap-identity \
            --enable-eap-mschapv2 \
            --enable-eap-radius \
            --enable-eap-tls \
            --enable-xauth-eap \
            --enable-vici \
            --enable-swanctl \
            --enable-sql \
            --enable-pgsql \
            --enable-sqlite \
            --enable-systemd \
            --enable-openssl \
            --enable-curl \
            --enable-ldap \
            --enable-pam \
            --enable-gcrypt \
            --enable-farp \
            --enable-dhcp \
            --enable-dhcp-inform \
            --enable-attr-sql \
            --enable-forecast \
            --disable-static

          make -j$(nproc)

      - name: Create DEB packages
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          DIST="${{ matrix.dist }}"
          ARCH="${{ matrix.arch }}"
          LIBSSL="${{ matrix.libssl }}"
          LIBLDAP="${{ matrix.libldap }}"

          # Main package
          PKGDIR="strongswan-sw_${VERSION}_${DIST}_${ARCH}"
          mkdir -p "${PKGDIR}/DEBIAN"

          make DESTDIR="$(pwd)/${PKGDIR}" install

          cat > "${PKGDIR}/DEBIAN/control" << EOF
          Package: strongswan-sw
          Version: ${VERSION}
          Section: net
          Priority: optional
          Architecture: ${ARCH}
          Depends: libgmp10, ${LIBSSL}, libcurl4, libsystemd0, libcap2, libpam0g, ${LIBLDAP}, libsqlite3-0, libgcrypt20
          Conflicts: strongswan, strongswan-charon, strongswan-starter
          Provides: strongswan (= ${VERSION})
          Replaces: strongswan, strongswan-charon, strongswan-starter
          Maintainer: Structured World Foundation <dev@sw.foundation>
          Homepage: https://github.com/structured-world/strongswan
          Description: strongSwan IPsec (SW fork)
           strongSwan is a complete IPsec implementation for Linux.
           This is the Structured World Foundation fork with socket permissions
           fix (umask 0660 for Unix sockets). Drop-in replacement for system
           strongswan package.
          EOF

          fakeroot dpkg-deb --build "${PKGDIR}"

          # PostgreSQL plugin package
          PGSQL_PKGDIR="strongswan-pgsql_${VERSION}_${DIST}_${ARCH}"
          mkdir -p "${PGSQL_PKGDIR}/DEBIAN"
          mkdir -p "${PGSQL_PKGDIR}/usr/lib/ipsec/plugins"
          mkdir -p "${PGSQL_PKGDIR}/etc/strongswan.d/charon"

          # Copy pgsql plugin to separate package, remove from main package
          PGSQL_SO=$(find "${PKGDIR}" -name "libstrongswan-pgsql.so" -type f | head -1)
          if [ -z "$PGSQL_SO" ]; then
            echo "ERROR: PostgreSQL plugin not found in build output"
            echo "Available plugins:"
            find "${PKGDIR}" -name "*.so" -path "*/plugins/*" | head -20
            exit 1
          fi
          cp -a "$PGSQL_SO" "${PGSQL_PKGDIR}/usr/lib/ipsec/plugins/"
          rm -f "$PGSQL_SO"

          cat > "${PGSQL_PKGDIR}/DEBIAN/control" << EOF
          Package: strongswan-pgsql
          Version: ${VERSION}
          Section: net
          Priority: optional
          Architecture: ${ARCH}
          Depends: strongswan (>= 6.0) | strongswan-sw, libpq5
          Maintainer: Structured World Foundation <dev@sw.foundation>
          Homepage: https://github.com/structured-world/strongswan
          Description: PostgreSQL plugin for strongSwan
           PostgreSQL database backend for strongSwan SQL plugin.
           Enables storing VPN user credentials and configuration in PostgreSQL.
           Works with system strongswan (>= 6.0) or strongswan-sw.
          EOF

          fakeroot dpkg-deb --build "${PGSQL_PKGDIR}"

          # DHCP-Inform plugin package
          DHCP_INFORM_PKGDIR="strongswan-dhcp-inform_${VERSION}_${DIST}_${ARCH}"
          mkdir -p "${DHCP_INFORM_PKGDIR}/DEBIAN"
          mkdir -p "${DHCP_INFORM_PKGDIR}/usr/lib/ipsec/plugins"

          # Copy dhcp-inform plugin to separate package, remove from main package
          DHCP_INFORM_SO=$(find "${PKGDIR}" -name "libstrongswan-dhcp-inform.so" -type f | head -1)
          if [ -n "$DHCP_INFORM_SO" ]; then
            cp -a "$DHCP_INFORM_SO" "${DHCP_INFORM_PKGDIR}/usr/lib/ipsec/plugins/"
            rm -f "$DHCP_INFORM_SO"
            echo "Found dhcp-inform plugin: $DHCP_INFORM_SO"
          else
            echo "WARNING: dhcp-inform plugin not found in build output"
            echo "Available plugins:"
            find "${PKGDIR}" -name "*.so" -path "*/plugins/*" | head -20
          fi

          cat > "${DHCP_INFORM_PKGDIR}/DEBIAN/control" << EOF
          Package: strongswan-dhcp-inform
          Version: ${VERSION}
          Section: net
          Priority: optional
          Architecture: ${ARCH}
          Depends: strongswan (>= 6.0) | strongswan-sw, strongswan-pgsql
          Maintainer: Structured World Foundation <dev@sw.foundation>
          Homepage: https://github.com/structured-world/strongswan
          Description: DHCP INFORM responder plugin for strongSwan
           Responds to Windows DHCPINFORM requests with split-tunnel routes
           from PostgreSQL database. Delivers routes via DHCP option 121/249.
           Works with system strongswan (>= 6.0) or strongswan-sw.
          EOF

          if [ -n "$DHCP_INFORM_SO" ]; then
            fakeroot dpkg-deb --build "${DHCP_INFORM_PKGDIR}"
          fi

          ls -la *.deb

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.dist }}-${{ matrix.arch }}
          path: "*.deb"
          retention-days: 7

  build-rpm:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - fedora: 39
            container: fedora:39
          - fedora: 40
            container: fedora:40
          - fedora: 41
            container: fedora:41
          - fedora: 42
            container: fedora:42

    runs-on: ubuntu-latest
    container: ${{ matrix.container }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          dnf install -y \
            git \
            gcc \
            make \
            autoconf \
            automake \
            libtool \
            pkgconfig \
            gettext-devel \
            gmp-devel \
            openssl-devel \
            libcurl-devel \
            libpq-devel \
            systemd \
            systemd-devel \
            systemd-rpm-macros \
            libcap-devel \
            pam-devel \
            openldap-devel \
            sqlite-devel \
            libgcrypt-devel \
            iptables-devel \
            gperf \
            flex \
            bison \
            rpm-build \
            rpmdevtools

          # Fedora 41+ moved deprecated OpenSSL ENGINE API to separate package
          if [ "${{ matrix.fedora }}" -ge 41 ]; then
            dnf install -y openssl-devel-engine
          fi

      - name: Build RPM and SRPM packages
        env:
          VERSION: ${{ needs.prepare.outputs.rpm_version }}
          UPSTREAM: ${{ needs.prepare.outputs.upstream_version }}
          SW_REV: ${{ needs.prepare.outputs.sw_rev }}
        run: |
          # Configure git for container environment
          # - safe.directory: required for newer git security checks
          # - user.email/name: required if git init is needed
          # - init.defaultBranch: avoid warnings on git init
          git config --global init.defaultBranch main
          git config --global user.email "build@sw.foundation"
          git config --global user.name "Build"
          git config --global --add safe.directory "$(pwd)"

          # Initialize git repo if not present (container checkout may not preserve .git)
          if [ ! -d .git ]; then
            git init
            git add -A
            git commit -m "Imported source"
          fi

          # Create git tag to satisfy strongSwan version check
          git tag -f "$UPSTREAM"

          # Setup rpmbuild structure
          rpmdev-setuptree

          # Create source tarball from git
          # NOTE: This naming must match packaging/rpm/strongswan-sw.spec Source0 and %autosetup
          SOURCE_NAME="strongswan-${UPSTREAM}-sw.${SW_REV}"
          if ! git archive --format=tar.gz --prefix="${SOURCE_NAME}/" HEAD > ~/rpmbuild/SOURCES/${SOURCE_NAME}.tar.gz; then
            echo "ERROR: Failed to create source tarball" >&2
            exit 1
          fi

          # Copy spec file from repository
          cp packaging/rpm/strongswan-sw.spec ~/rpmbuild/SPECS/

          # Build binary RPMs, SRPMs, and debuginfo packages
          rpmbuild -ba ~/rpmbuild/SPECS/strongswan-sw.spec \
            --define "upstream_version ${UPSTREAM}" \
            --define "sw_rev ${SW_REV}" \
            --define "_topdir $HOME/rpmbuild"

          # Copy all packages to workspace
          mkdir -p rpms srpms
          cp ~/rpmbuild/RPMS/*/*.rpm rpms/ 2>/dev/null || true
          cp ~/rpmbuild/SRPMS/*.rpm srpms/ 2>/dev/null || true

          # Verify that packages were actually built
          if ! ls rpms/*.rpm 1>/dev/null 2>&1; then
            echo "ERROR: No RPM packages were built" >&2
            exit 1
          fi
          if ! ls srpms/*.rpm 1>/dev/null 2>&1; then
            echo "ERROR: No SRPM packages were built" >&2
            exit 1
          fi

          echo "=== Binary RPMs ==="
          ls -la rpms/
          echo "=== Source RPMs ==="
          ls -la srpms/

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-fc${{ matrix.fedora }}
          path: "rpms/*.rpm"
          retention-days: 7

      # Upload SRPM only from fc42 job to avoid duplicates (SRPMs are identical across distros)
      # If fc42 build fails, SRPMs won't be uploaded - this is acceptable as binary
      # RPMs are the primary deliverable and SRPMs can be regenerated from git
      - name: Upload SRPM artifacts
        if: matrix.fedora == 42
        uses: actions/upload-artifact@v4
        with:
          name: srpm
          path: "srpms/*.rpm"
          retention-days: 7

  publish:
    needs: [prepare, build-deb, build-rpm]
    runs-on: ubuntu-latest

    steps:
      - name: Download all DEB artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages/deb
          pattern: deb-*
          merge-multiple: true

      - name: Download all RPM artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages/rpm
          pattern: rpm-*
          merge-multiple: true

      - name: Download SRPM artifact
        # continue-on-error: SRPM is only uploaded from fc42; if that build fails, skip SRPM
        continue-on-error: true
        id: download-srpm
        uses: actions/download-artifact@v4
        with:
          path: packages/srpm
          name: srpm

      - name: List packages
        run: |
          echo "=== DEB packages ==="
          ls -la packages/deb/
          echo "=== RPM packages ==="
          ls -la packages/rpm/
          echo "=== SRPM packages ==="
          ls -la packages/srpm/ 2>/dev/null || echo "No SRPM packages (fc42 build may have failed)"

      - name: Clone repository
        uses: actions/checkout@v4
        with:
          repository: structured-world/repo
          token: ${{ secrets.REPO_TOKEN }}
          path: repo

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y apt-utils createrepo-c gnupg

      - name: Import GPG key
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          # Test signing (validates key import, passphrase optional)
          if [ -n "$GPG_PASSPHRASE" ]; then
            echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --sign --armor /dev/null || true
          fi

      - name: Publish DEB packages
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"

          cd repo

          # Copy DEB packages to pool
          for deb in ../packages/deb/*.deb; do
            PKGNAME=$(dpkg-deb -f "$deb" Package)
            FIRST_LETTER="${PKGNAME:0:1}"
            POOL_DIR="deb/pool/main/${FIRST_LETTER}/${PKGNAME}"
            mkdir -p "$POOL_DIR"
            cp "$deb" "$POOL_DIR/"
            echo "Copied $deb to $POOL_DIR/"
          done

          # GPG signing helper
          gpg_sign() {
            if [ -n "$GPG_PASSPHRASE" ]; then
              gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" "$@"
            else
              gpg --batch --yes "$@"
            fi
          }

          # Update Packages index for each distribution
          for dist in jammy noble bookworm; do
            DIST_DIR="deb/dists/${dist}"
            mkdir -p "${DIST_DIR}/main/binary-amd64"

            # Generate Packages file
            apt-ftparchive packages "deb/pool/main" | \
              grep -A 1000 "Filename: .*_${dist}_" > "${DIST_DIR}/main/binary-amd64/Packages" || true

            # If no dist-specific packages, generate from all
            if [ ! -s "${DIST_DIR}/main/binary-amd64/Packages" ]; then
              apt-ftparchive packages "deb/pool/main" > "${DIST_DIR}/main/binary-amd64/Packages"
            fi

            gzip -kf "${DIST_DIR}/main/binary-amd64/Packages"

            # Generate Release file
            cat > "${DIST_DIR}/Release" << EOF
          Origin: SW Foundation
          Label: SW Foundation
          Suite: ${dist}
          Codename: ${dist}
          Architectures: amd64
          Components: main
          Description: SW Foundation Package Repository
          EOF

            # Add checksums
            apt-ftparchive release "${DIST_DIR}" >> "${DIST_DIR}/Release"

            # Sign Release file
            gpg_sign --armor --detach-sign -o "${DIST_DIR}/Release.gpg" "${DIST_DIR}/Release"
            gpg_sign --clearsign -o "${DIST_DIR}/InRelease" "${DIST_DIR}/Release"

            echo "Updated ${dist} repository"
          done

      - name: Publish RPM packages
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          cd repo

          # GPG signing helper
          gpg_sign() {
            if [ -n "$GPG_PASSPHRASE" ]; then
              gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" "$@"
            else
              gpg --batch --yes "$@"
            fi
          }

          # Copy RPM packages to appropriate Fedora directories
          for rpm in ../packages/rpm/*.rpm; do
            FILENAME=$(basename "$rpm")
            # Extract fc version from filename (e.g., strongswan-sw-6.0.4.sw.2-1.fc40.x86_64.rpm)
            if [[ "$FILENAME" =~ \.fc([0-9]+)\. ]]; then
              FC_VER="${BASH_REMATCH[1]}"
              DEST_DIR="rpm/fc${FC_VER}"
              mkdir -p "$DEST_DIR"
              cp "$rpm" "$DEST_DIR/"
              echo "Copied $rpm to $DEST_DIR/"
            fi
          done

          # Copy SRPM packages to a single distro-agnostic directory
          # (SRPMs are source packages and can be rebuilt for any distro)
          SRPM_DIR="rpm/SRPMS"
          mkdir -p "$SRPM_DIR"
          if ls ../packages/srpm/*.rpm 1>/dev/null 2>&1; then
            for srpm in ../packages/srpm/*.rpm; do
              cp "$srpm" "$SRPM_DIR/"
              echo "Copied $srpm to $SRPM_DIR/"
            done

            # Create SRPM repository metadata
            createrepo_c --update "$SRPM_DIR"
            gpg_sign --armor --detach-sign -o "${SRPM_DIR}/repodata/repomd.xml.asc" \
              "${SRPM_DIR}/repodata/repomd.xml"
            echo "Updated SRPM repository"
          else
            echo "No SRPM packages found to copy"
          fi

          # Update repository metadata for each Fedora version
          for fc in 39 40 41 42; do
            FC_DIR="rpm/fc${fc}"
            if [ -d "$FC_DIR" ] && ls "$FC_DIR"/*.rpm 1>/dev/null 2>&1; then
              createrepo_c --update "$FC_DIR"

              # Sign repomd.xml
              gpg_sign --armor --detach-sign -o "${FC_DIR}/repodata/repomd.xml.asc" \
                "${FC_DIR}/repodata/repomd.xml"

              echo "Updated fc${fc} repository"
            fi
          done

      - name: Commit and push
        run: |
          cd repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          git status

          VERSION="${{ needs.prepare.outputs.version }}"
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Release strongSwan SW ${VERSION}"
            git push
            echo "Pushed release ${VERSION} to repository"
          fi

  # Create GitHub Release in the fork (no artifacts, just links to package repo)
  release:
    needs: [prepare, publish]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          UPSTREAM="${{ needs.prepare.outputs.upstream_version }}"

          # Create release notes (using {{PLACEHOLDER}} pattern for clarity)
          cat > release-notes.md << 'EOF'
          ## strongSwan SW {{VERSION}}

          This release is based on upstream strongSwan {{UPSTREAM}} with SW fork modifications.

          ### Installation

          Packages are available from the [repo](https://github.com/structured-world/repo).

          **Fedora/RHEL:**
          ```bash
          # Add repository (one-time setup)
          sudo dnf config-manager --add-repo https://structured-world.github.io/repo/rpm/fc\$releasever/strongswan-sw.repo

          # Install
          sudo dnf install strongswan-sw
          ```

          **Ubuntu/Debian:**
          ```bash
          # Add repository (one-time setup)
          curl -fsSL https://structured-world.github.io/repo/deb/gpg.key | sudo gpg --dearmor -o /usr/share/keyrings/strongswan-sw.gpg
          echo "deb [signed-by=/usr/share/keyrings/strongswan-sw.gpg] https://structured-world.github.io/repo/deb $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/strongswan-sw.list

          # Install
          sudo apt update && sudo apt install strongswan-sw
          ```

          ### SW Fork Changes

          - PostgreSQL database plugin for SQL authentication
          - Unix socket permissions fix (umask 0660)
          - DHCP-inform plugin for Windows split-tunnel routes

          For full changelog, see the [sw branch](https://github.com/structured-world/strongswan/tree/sw).
          EOF

          # Substitute placeholders in release notes
          sed -i "s/{{VERSION}}/${VERSION}/g" release-notes.md
          sed -i "s/{{UPSTREAM}}/${UPSTREAM}/g" release-notes.md

          # Create or update GitHub release (idempotent)
          if gh release view "${VERSION}" >/dev/null 2>&1; then
            echo "Release ${VERSION} exists, updating..."
            gh release edit "${VERSION}" \
              --title "strongSwan SW ${VERSION}" \
              --notes-file release-notes.md
          else
            echo "Creating release ${VERSION}..."
            gh release create "${VERSION}" \
              --title "strongSwan SW ${VERSION}" \
              --notes-file release-notes.md \
              --target sw
          fi
