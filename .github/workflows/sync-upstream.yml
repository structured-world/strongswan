name: Sync with Upstream

on:
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      force_rebase:
        description: 'Force rebase even if no upstream changes'
        required: false
        default: false
        type: boolean

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/strongswan/strongswan.git || true
          git fetch upstream

      - name: Check for upstream changes
        id: check
        run: |
          UPSTREAM_SHA=$(git rev-parse upstream/master)
          CURRENT_SHA=$(git rev-parse origin/master)

          if [ "$UPSTREAM_SHA" = "$CURRENT_SHA" ] && [ "${{ inputs.force_rebase }}" != "true" ]; then
            echo "No upstream changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Upstream changes detected or force rebase requested"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "upstream_sha=$UPSTREAM_SHA" >> $GITHUB_OUTPUT
          fi

      - name: Sync master branch
        if: steps.check.outputs.has_changes == 'true'
        run: |
          git checkout master
          git merge upstream/master --ff-only
          git push origin master

      - name: Rebase sw branch
        if: steps.check.outputs.has_changes == 'true'
        id: rebase
        run: |
          git checkout sw

          # Try to rebase
          if git rebase master; then
            echo "Rebase successful"
            git push origin sw --force-with-lease
            echo "rebase_success=true" >> $GITHUB_OUTPUT
          else
            echo "Rebase failed - conflicts detected"
            git rebase --abort
            echo "rebase_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue on conflict
        if: steps.check.outputs.has_changes == 'true' && steps.rebase.outputs.rebase_success == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const title = '⚠️ Upstream sync conflict detected';
            const body = `## Upstream Sync Failed

            The automatic rebase of the \`sw\` branch onto the updated \`master\` branch failed due to conflicts.

            **Upstream commit:** ${{ steps.check.outputs.upstream_sha }}

            ### Manual resolution required:

            \`\`\`bash
            git fetch origin
            git fetch upstream
            git checkout sw
            git rebase upstream/master
            # Resolve conflicts
            git push origin sw --force-with-lease
            \`\`\`

            Please resolve the conflicts and push the updated branch.`;

            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['upstream-sync', 'needs-attention']
              });
            }
